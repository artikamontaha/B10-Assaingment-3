;/*FB_PKG_DELIM*/

__d("MAWDeanonMessagesMetadataQuery_facebookRelayOperation",[],(function(a,b,c,d,e,f){e.exports="8027437630658405"}),null);
__d("MAWDeanonMessagesMetadataQuery.graphql",["MAWDeanonMessagesMetadataQuery_facebookRelayOperation"],(function(a,b,c,d,e,f){"use strict";a=function(){var a=[{defaultValue:null,kind:"LocalArgument",name:"data"}],c={alias:null,args:null,concreteType:"XFBEncryptedBackupMailbox",kind:"LinkedField",name:"mailbox",plural:!1,selections:[{alias:null,args:[{kind:"Variable",name:"data",variableName:"data"}],concreteType:"XFBTDeanonMessagesResponse",kind:"LinkedField",name:"deanon_messages_metadata",plural:!0,selections:[{alias:null,args:null,kind:"ScalarField",name:"offline_threading_id",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"sort_order_ms",storageKey:null}],storageKey:null}],storageKey:null};return{fragment:{argumentDefinitions:a,kind:"Fragment",metadata:null,name:"MAWDeanonMessagesMetadataQuery",selections:[{alias:null,args:null,concreteType:"Viewer",kind:"LinkedField",name:"viewer",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackup",kind:"LinkedField",name:"encrypted_backup",plural:!1,selections:[c],storageKey:null}],storageKey:null}],type:"Query",abstractKey:null},kind:"Request",operation:{argumentDefinitions:a,kind:"Operation",name:"MAWDeanonMessagesMetadataQuery",selections:[{alias:null,args:null,concreteType:"Viewer",kind:"LinkedField",name:"viewer",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackup",kind:"LinkedField",name:"encrypted_backup",plural:!1,selections:[c,{alias:null,args:null,kind:"ScalarField",name:"id",storageKey:null}],storageKey:null}],storageKey:null}]},params:{id:b("MAWDeanonMessagesMetadataQuery_facebookRelayOperation"),metadata:{},name:"MAWDeanonMessagesMetadataQuery",operationKind:"query",text:null}}}();e.exports=a}),null);
__d("MAWDeanonMessagesMetadataQuery",["CometRelay","FBLogger","I64","MAWDeanonMessagesMetadataQuery.graphql"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j=h!==void 0?h:h=b("MAWDeanonMessagesMetadataQuery.graphql");function a(a,b,e,f,g,h){g===void 0&&(g=null);return d("CometRelay").fetchQuery(a,j,{data:{act_thread_id:b,direction:e,reference_timestamp:g,requested_messages:f}},h?{fetchPolicy:h}:void 0).toPromise().then(function(a){a=a==null?void 0:(a=a.viewer)==null?void 0:(a=a.encrypted_backup)==null?void 0:(a=a.mailbox)==null?void 0:a.deanon_messages_metadata;var b=new Set();return((a=a)!=null?a:[]).map(function(a){var e=a.offline_threading_id;e!=null&&(b.has(e)&&c("FBLogger")("labyrinth_web").warn("[MAWDeanonMessagesMetadataQuery] Duplicate message returned from server in the deanon API"),b.add(e));return{offline_threading_id:a.offline_threading_id,sort_order_ms:a.sort_order_ms!=null?(i||(i=d("I64"))).of_string(a.sort_order_ms):null}})})}g.fetchDeanonMsgsMetadata=a}),98);
__d("MAWEBDeanonFetch",["FBLogger","I64","MAWDeanonMessagesMetadataQuery","WAJids","WAResultOrError","XPlatRelayEnvironment","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a){return i.apply(this,arguments)}function i(){i=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.chatJid,e=a.count,f=a.direction,g=a.fetchPolicy;a=a.timestampMs;try{b=(yield d("MAWDeanonMessagesMetadataQuery").fetchDeanonMsgsMetadata(d("XPlatRelayEnvironment").getRelayEnvironment(),d("WAJids").threadIdForChatJid(b),f,e,a,g));f=b.reduce(function(a,b){var c=b.offline_threading_id;b=b.sort_order_ms;b!=null&&c!=null&&a.push({externalId:c,msgType:"unknown-deanon",sortOrderMs:(h||(h=d("I64"))).to_float(b)});return a},[]);return d("WAResultOrError").makeResult(f)}catch(a){c("FBLogger")("messenger_web_missing_messages").catching(a).mustfix("Deanon GraphQL fails with error");return d("WAResultOrError").makeError("request-error",a.message)}});return i.apply(this,arguments)}g.fetchMessagesMetadataFromEBDeanon=a}),98);
__d("MAWMessageIntegrityChecker",["FBLogger","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function h(a,b){if(a.externalId===b.externalId)return 0;if(a.sortOrderMs>b.sortOrderMs)return 1;return a.sortOrderMs<b.sortOrderMs?-1:-1}function i(a){return function(b,c){if(b.sortOrderMs===c.sortOrderMs){var d,e;d=(d=b.externalId)!=null?d:"";e=(e=c.externalId)!=null?e:"";if(a!=null){d=a.has(d);e=a.has(e);if(d&&!e)return-1;else if(!d&&e)return 1}return((d=c.externalId)!=null?d:"").localeCompare((e=b.externalId)!=null?e:"")}return c.sortOrderMs-b.sortOrderMs}}var j=i();function k(a,b){var c=b.reduce(function(a,b){b.externalId!=null&&a.set(b.externalId,b.sortOrderMs);return a},new Map());return a.map(function(a){var b;return babelHelpers["extends"]({},a,{sortOrderMs:(b=a.externalId!=null?c.get(a.externalId):null)!=null?b:a.sortOrderMs})}).sort(j)}function l(a,b,c){a=new Set(a.map(function(a){return a.externalId}).filter(Boolean));return b.toSorted(i(a)).slice(0,c)}function a(a,b,d,e,f){var g=new Set(a.map(function(a){return a.externalId})),i=new Set(b.map(function(a){return a.externalId})),j=n(g,i);i=n(i,g);g=k(a,b);a=l(g,b,d);b=0;var m=0,o=0,p=0,q=[],r=null;while(b<g.length&&m<a.length){var s=g[b],t=a[m];if(r!=null&&h(t,r)===0){m+=1;r=t;c("FBLogger")("messenger_web_missing_messages").mustfix("Detected duplicate messages in reference. Target source: %s, reference source: %s",e,f);continue}var u=h(s,t);u===0?(b+=1,m+=1,r=t,q.push([s,{result:"consistent"}])):u<0?(m+=1,r=t,o+=1,q.push([t,{result:"missing_in_target"}])):(b+=1,p+=1,q.push([s,{result:"missing_in_reference"}]))}while(b<g.length){u=g[b];b+=1;a.length<d?(p+=1,q.push([u,{result:"missing_in_reference"}])):q.push([u,{result:"skipped"}])}while(m<a.length){t=a[m];m+=1;g.length<d?(o+=1,q.push([t,{result:"missing_in_target"}])):q.push([t,{result:"skipped"}])}if(o===0&&p===0)return{detailedResults:q,result:"consistent",setDifferenceInReference:i,setDifferenceInTarget:j};else if(o>0&&p===0)return{detailedResults:q,numOfMissingMessages:o,result:"missing_in_target",setDifferenceInReference:i,setDifferenceInTarget:j};else if(o===0&&p>0)return{detailedResults:q,numOfMissingMessages:p,result:"missing_in_reference",setDifferenceInReference:i,setDifferenceInTarget:j};else return{detailedResults:q,numOfMissingMessages:p+o,result:"missing_in_both",setDifferenceInReference:i,setDifferenceInTarget:j}}function d(a,b){return m.apply(this,arguments)}function m(){m=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){var d=b.filter(function(a){a[0];a=a[1];return a.result==="missing_in_target"}).map(function(a){var b=a[0];a[1];return b.externalId}),e=(yield a.fetchMessagesByExternalId(d,{admin:!1,editMsgHistory:!1,media:!1,reactions:!1,receiverFetch:!1,xma:!1})),f=new Set(e.map(function(a){return a.externalId}));return b.map(function(a){var b=a[0];a=a[1];if(f.has(b.externalId)){var d=e.find(function(a){return a.externalId===b.externalId});if(!d){c("FBLogger")("messenger_web_missing_messages").mustfix("Failed to find msg with external id: %s in MAW",b.externalId);return[b,{result:"missing_in_target_invalid_sortOrder"}]}d=d.sortOrderMs-b.sortOrderMs;return[b,{result:"missing_in_target_invalid_sortOrder",sortOrderSkewMs:d}]}return[b,a]})});return m.apply(this,arguments)}function n(a,b){var c=0;for(a of a)b.has(a)||(c+=1);return c}g.compareMessageMetadataForDescOrder=j;g.checkIntegrityforMessageList=a;g.checkMsgsExistenceInMAWAndDecomposeTargetConsistencyResult=d}),98);